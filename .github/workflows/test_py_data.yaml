name: ShpData - Build, install & pytest

on:
  workflow_call:

jobs:
  utdata:

    strategy:
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        python-version: [ "3.14", "3.12", "3.10" ] # min 4 versions / years

    runs-on: ${{ matrix.os }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.os }}-${{ matrix.python-version }}-data
      cancel-in-progress: true

    steps:

      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v5

      - name: Install uv ğŸ”§
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          activate-environment: true

      - name: Install apt-dependencies ğŸ”§
        run: sudo apt install build-essential
        if: ${{ matrix.os == 'ubuntu-latest' }}

      - name: Test-Build data-package ğŸ§±
        run: uv build --clear
        working-directory: "./shepherd_data"

      - name: Install core-package ğŸ§±
        run: uv pip install .[test,inventory]
        working-directory: "./shepherd_core"
      - name: Install ELF-support ğŸ§±
        run: uv pip install .[elf]
        working-directory: "./shepherd_core"
        if: ${{ matrix.os != 'windows-latest' }}
      - name: Install data-package ğŸ§±
        run: uv pip install .[test]
        working-directory: "./shepherd_data"

      - name: Test data-package with pytest ğŸ§«
        uses: nick-fields/retry@v3
        with:
          command: |
            cd ./shepherd_data
            pytest
          max_attempts: 3
          timeout_minutes: 99 # mandatory / stupid
        # â¤· workaround for flakey TCL-bug triggered by combination of
        #   windows, matplotlib, some python-versions
